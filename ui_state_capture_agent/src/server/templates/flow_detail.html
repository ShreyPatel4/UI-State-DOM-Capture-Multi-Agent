{% extends "base.html" %}

{% block content %}
<section class="panel">
    <header class="panel-header">
        <div>
            <p class="eyebrow">Flow</p>
            <h2>{{ flow.task_title }}</h2>
            <p class="muted">{{ flow.task_blurb }}</p>
        </div>
        <div class="flow-meta">
            <div><span class="label">App</span><strong>{{ flow.app_name }}</strong></div>
            <div><span class="label">Run ID</span><strong>{{ flow.run_id }}</strong></div>
            <div><span class="label">Status</span><strong class="status status-{{ flow.status | lower }}">{{ flow.status }}</strong></div>
            <div><span class="label">Started</span><strong>{{ flow.started_at }}</strong></div>
            <div>
                <a class="button" href="{{ url_for('flow_logs', flow_id=flow.id) }}" target="_blank" rel="noopener noreferrer">View logs</a>
            </div>
            {% if flow.status == "running" %}
                <div>
                    <button id="cancel-run" class="button">Stop run</button>
                </div>
            {% endif %}
        </div>
    </header>
</section>

<section class="steps-grid">
    {% for step in steps %}
    <article class="step-card">
        <div class="step-meta">
            <div class="step-index">#{{ step.step_index }}</div>
            <div>
                <p class="eyebrow">State: {{ step.state_label }}</p>
                <h3>{{ step.description }}</h3>
                <div class="state-meta">
                    {% if step.url_changed %}
                        <span class="pill pill-url">URL change</span>
                    {% else %}
                        <span class="pill pill-dom">Same URL</span>
                    {% endif %}
                    {% if step.state_kind %}
                        <span class="pill pill-kind">{{ step.state_kind }}</span>
                    {% endif %}
                </div>
                <div class="state-url">
                    <code>{{ step.url }}</code>
                </div>
            </div>
        </div>
        <div class="step-image">
            <img src="{{ url_for('get_screenshot', flow_id=flow.id, step_index=step.step_index) }}" alt="Step {{ step.step_index }} screenshot" loading="lazy">
        </div>
    </article>
    {% else %}
    <p class="empty">No steps recorded for this flow.</p>
    {% endfor %}
</section>
{% if flow.status == "running" %}
<script>
    const flowId = "{{ flow.id }}";
    let lastStepCount = {{ steps|length }};
    let lastLogCount = 0;

    async function fetchLogCount() {
        try {
            const res = await fetch(`/api/flows/${flowId}/status`);
            if (!res.ok) return null;
            const data = await res.json();
            lastLogCount = data.log_count;
        } catch (error) {
            console.error("Failed to fetch initial counts", error);
        }
    }

    fetchLogCount();

    const intervalMs = 1500;

    async function pollFlow() {
        try {
            const res = await fetch(`/api/flows/${flowId}/status`);
            if (!res.ok) return;
            const data = await res.json();
            if (data.status === "running" && (data.step_count !== lastStepCount || data.log_count !== lastLogCount)) {
                window.location.reload();
            }
        } catch (error) {
            console.error("pollFlow error", error);
        }
    }

    if ("{{ flow.status }}" === "running") {
        setInterval(pollFlow, intervalMs);
    }

    const cancelButton = document.getElementById("cancel-run");
    if (cancelButton) {
        cancelButton.addEventListener("click", async () => {
            cancelButton.disabled = true;
            cancelButton.textContent = "Stopping...";
            try {
                await fetch(`/flows/{{ flow.id }}/cancel`, { method: "POST" });
                cancelButton.textContent = "Stop requested";
            } catch (error) {
                console.error("Failed to request cancellation", error);
                cancelButton.disabled = false;
                cancelButton.textContent = "Stop run";
            }
        });
    }
</script>
{% endif %}
{% endblock %}
